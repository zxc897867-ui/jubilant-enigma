<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>房屋資訊自動生成器</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <style>
    body { font-family: "微軟正黑體", Arial, sans-serif; margin: 30px; }
    label { display: block; margin: 8px 0 2px; }
    input[type="text"], select, textarea { box-sizing: border-box; font-size: 16px; }
    /* 防止手機輸入框放大 */
    input[type="text"], input[type="number"], select, textarea {
      font-size: 16px !important;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      -webkit-text-size-adjust: 100%;
      transform-origin: left top;
      -webkit-transform-origin: left top;
    }
    @media screen and (max-width: 768px) {
      input[type="text"], input[type="number"], select, textarea {
        font-size: 16px !important;
        -webkit-transform: scale(1);
        transform: scale(1);
        zoom: 1;
      }
    }
    input[type="radio"], input[type="checkbox"] { margin-right: 4px; margin-left: 0; vertical-align: middle; }
    .auto-grow { min-width: 120px; width: auto; max-width: 60vw; transition: width 0.2s; }
    .square-textarea { width: 200px; height: 200px; resize: both; font-size: 16px; box-sizing: border-box; display: block; }
    .small-input { width: 25px !important; height: 25px; text-align: center; font-size: 14px; padding: 2px; min-width: 25px !important; max-width: 25px !important; }
    input[type="radio"]:checked, input[type="checkbox"]:checked { accent-color: orange; }
    textarea { margin-top: 10px; width: 100%; font-size: 18px; }
    button { margin: 10px 5px 0 0; padding: 8px 16px; }
    .row { display: flex; align-items: flex-start; margin-bottom: 8px; flex-wrap: wrap; }
    .row label { margin: 0 4px 0 0; font-weight: bold; display: inline-block; white-space: nowrap; }
    .inline-options {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 16px;
      align-items: center;
    }
    .inline-options label {
      display: flex;
      align-items: center;
      margin-right: 0;
      font-weight: normal;
      white-space: nowrap;
      font-size: 16px;
    }
    .inline-options input[type="radio"] {
      margin-right: 4px;
    }
    /* 針對手機優化的媒體查詢 */
    @media (max-width: 768px) {
      .row label {
        min-width: auto;
        margin-right: 2px;
      }
      .inline-options {
        gap: 6px 12px;
      }
      .inline-options label {
        font-size: 14px;
      }
    }
    #date { width: 140px; max-width: 40vw; height: 36px; border-radius: 4px; font-size: 16px; padding: 4px 8px; margin-right: 10px; }
    #today_obj { width: 150px; max-width: 35vw; height: 36px; border-radius: 4px; font-size: 16px; padding: 4px 8px; }
    .ocr-section {
      background: #f8f9fa;
      border: 2px dashed #ddd;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
      text-align: center;
    }
    .ocr-title { font-weight: bold; color: #333; margin-bottom: 10px; font-size: 16px; }
    .ocr-subtitle { color: #666; font-size: 14px; margin-bottom: 10px; }
    #deedImg { margin: 10px 0; font-size: 14px; }
    #ocrResult { font-size:13px;color:#888;word-break:break-all; margin-top: 10px; text-align: left; max-height: 200px; overflow-y: auto; background: #fff; padding: 10px; border-radius: 4px; border: 1px solid #ddd; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h2>房屋資訊自動生成器</h2>
  <form id="houseForm" autocomplete="off">
    <!-- 日期 + 今日物件 -->
    <div class="row" style="flex-wrap: nowrap; overflow-x: auto;">
      <label style="min-width:40px;margin-right:4px;flex-shrink:0;">日期</label>
      <input name="date" id="date" style="width:100px;margin-right:8px;flex-shrink:0;" readonly>
      <label style="margin-right:4px;flex-shrink:0;">今日物件</label>
      <input name="today_obj" id="today_obj" placeholder="可填寫" style="width:120px;max-width:none;flex-shrink:1;min-width:80px;">
    </div>
    <!-- 可否廣告 -->
    <div class="row">
      <label>可否廣告：</label>
      <div class="inline-options">
        <label><input type="radio" name="ad" value="可刊登">可刊登</label>
        <label><input type="radio" name="ad" value="不可刊登591可刊登其他平台">不可刊登591可刊登其他平台</label>
        <label><input type="radio" name="ad" value="不可刊登">不可刊登</label>
      </div>
    </div>
    <!-- 可否簽委托書 -->
    <div class="row">
      <label>可否簽委托書：</label>
      <div class="inline-options">
        <label><input type="radio" name="sign" value="可(已簽)">可(已簽)</label>
        <label><input type="radio" name="sign" value="可(可補簽)">可(可補簽)</label>
        <label><input type="radio" name="sign" value="不可(可上架廣告)">不可(可上架廣告)</label>
        <label><input type="radio" name="sign" value="不可">不可</label>
      </div>
    </div>
    <!-- 地址 -->
    <label>地址：<input name="address" class="auto-grow" required></label>
    <!-- 頂加是否為民國84年前增建 -->
    <label>頂加是否為民國84年前增建：
      <input type="radio" name="top" value="是">是
      <input type="radio" name="top" value="否">否
    </label>
    <!-- 房號 -->
    <label>房號：<input name="room" class="auto-grow">
      <input type="radio" name="room_none" value="無">無
    </label>
    <!-- 總樓層 -->
    <label>總樓層：<input name="floor" class="auto-grow" required></label>
    <!-- 建物型態 -->
    <label>建物型態：<input name="type" class="auto-grow" required></label>
    <!-- 坪數 -->
    <label>坪數：<input name="area" class="auto-grow" required></label>
    <!-- 謄本檢核區塊 -->
    <div class="ocr-section">
      <div class="ocr-title">📷 謄本資訊智能檢核</div>
      <div class="ocr-subtitle">自動檢核：地址、樓層、坪數</div>
      <input type="file" id="deedImg" accept="image/*">
      <button type="button" onclick="ocrAndCompare()" style="font-size:14px;">辨識並比對</button>
      <div id="ocrResult"></div>
    </div>
    <!-- 格局 -->
    <label style="font-size: 14px;">
      格局：
      <input type="text" name="layout_room" class="small-input" maxlength="2" placeholder="房"> <span style="font-size: 12px;">房</span>
      <input type="text" name="layout_living" class="small-input" maxlength="2" placeholder="廳"> <span style="font-size: 12px;">廳</span>
      <input type="text" name="layout_bath" class="small-input" maxlength="2" placeholder="衛浴"> <span style="font-size: 12px;">衛浴</span>
      <input type="text" name="layout_kitchen" class="small-input" maxlength="2" placeholder="廚房"> <span style="font-size: 12px;">廚房</span>
      <input type="text" name="layout_balcony" class="small-input" maxlength="2" placeholder="陽台"> <span style="font-size: 12px;">陽台</span>
      <label style="font-size: 12px;"><input type="checkbox" name="layout_option" value="開放式">開放式</label>
      <label style="font-size: 12px;"><input type="checkbox" name="layout_option" value="樓中樓">樓中樓</label>
    </label>
    <label>租金：<input name="rent" class="auto-grow" required></label>
    <label>管理費：<input name="fee" class="auto-grow" required>
      <input type="radio" name="fee_none" value="無">無
    </label>
    <label>底價：<input name="base" class="auto-grow" required></label>
    <!-- 報稅、租補、入籍、寵物、垃圾代收、停車位 -->
    <div class="row">
      <label>報稅：</label>
      <div class="inline-options">
        <label><input type="radio" name="tax" value="可">可</label>
        <label><input type="radio" name="tax" value="否">否</label>
        <label><input type="radio" name="tax" value="其他">其他</label>
      </div>
    </div>
    <div class="row">
      <label>租補：</label>
      <div class="inline-options">
        <label><input type="radio" name="subsidy" value="可">可</label>
        <label><input type="radio" name="subsidy" value="否">否</label>
        <label><input type="radio" name="subsidy" value="其他">其他</label>
      </div>
    </div>
    <div class="row">
      <label>入籍：</label>
      <div class="inline-options">
        <label><input type="radio" name="register" value="可">可</label>
        <label><input type="radio" name="register" value="否">否</label>
        <label><input type="radio" name="register" value="其他">其他</label>
      </div>
    </div>
    <div class="row">
      <label>寵物：</label>
      <div class="inline-options">
        <label><input type="radio" name="pet" value="否">否</label>
        <label><input type="radio" name="pet" value="可">可</label>
        <label><input type="radio" name="pet" value="可貓">可貓</label>
        <label><input type="radio" name="pet" value="可狗">可狗</label>
        <label><input type="radio" name="pet" value="其他">其他</label>
      </div>
    </div>
    <div class="row">
      <label>垃圾代收：</label>
      <div class="inline-options">
        <label><input type="radio" name="garbage" value="有">有</label>
        <label><input type="radio" name="garbage" value="無">無</label>
        <label><input type="radio" name="garbage" value="其他">其他</label>
      </div>
    </div>
    <div class="row">
      <label>停車位：</label>
      <div class="inline-options">
        <label><input type="radio" name="parking" value="有">有</label>
        <label><input type="radio" name="parking" value="無">無</label>
        <label><input type="radio" name="parking" value="其他">其他</label>
      </div>
    </div>
    <label>公設：<input name="public" class="auto-grow" placeholder="請填寫公設內容"></label>
    <label>電費$/度：<input name="electric" class="auto-grow" required></label>
    <label>水費：<input name="water" class="auto-grow" required></label>
    <label>瓦斯：<input name="gas" class="auto-grow" required></label>
    <label>鄰近交通(站點/分鐘)：<input name="traffic" class="auto-grow" required></label>
    <label>帶看方式：<input name="show" class="auto-grow" required></label>
    <label>附加設備：<textarea name="equip" class="square-textarea" required></textarea></label>
    <label>注意事項(生活機能、東服等補充)：<textarea name="note" class="square-textarea" required></textarea></label>
    <label>開發：<input name="dev" class="auto-grow" required></label>
    <button type="button" onclick="generate()">產生格式</button>
    <button type="button" onclick="copyText()">複製內容</button>
  </form>
  <textarea id="output" readonly placeholder="這裡會自動產生格式內容" oninput="autoGrow(this)"></textarea>
  <script>
    // OCR比對功能
    function toChineseNumber(n) {
      const map = ['零','一','二','三','四','五','六','七','八','九'];
      if (n === 100) return '一百';
      if (n === 10) return '十';
      if (n < 10) return map[n];
      if (n < 20) return '十' + map[n % 10];
      if (n < 100) {
        return map[Math.floor(n/10)] + '十' + (n%10 === 0 ? '' : map[n%10]);
      }
      return n;
    }
    function numToChinese(str) {
      return str.replace(/([0-9]{1,3})樓/g, function(match, p1) {
        return toChineseNumber(parseInt(p1)) + '樓';
      });
    }
    function chineseNumberToNum(ch) {
      const map = {'零':0,'一':1,'二':2,'三':3,'四':4,'五':5,'六':6,'七':7,'八':8,'九':9};
      if (ch === '十') return 10;
      if (ch === '一百') return 100;
      if (ch.length === 2 && ch[0] === '十') return 10 + map[ch[1]];
      if (ch.length === 2 && ch[1] === '十') return map[ch[0]] * 10;
      if (ch.length === 3 && ch[1] === '十') return map[ch[0]] * 10 + map[ch[2]];
      return map[ch] || ch;
    }
    function chineseToNum(str) {
      return str.replace(/([一二三四五六七八九十百]+)樓/g, function(match, p1) {
        return chineseNumberToNum(p1) + '樓';
      });
    }
    // 新增：正規化地址
    function normalizeAddress(str) {
      return str.replace(/[\s,，。．、:：\-—_()（）]/g, '')
                .replace(/[０-９]/g, d => String.fromCharCode(d.charCodeAt(0) - 65248));
    }
    function addressMatch(formAddr, deedAddr) {
      const f = normalizeAddress(formAddr);
      const d = normalizeAddress(deedAddr);
      const fNumToChinese = numToChinese(f);
      const dNumToChinese = numToChinese(d);
      const fChineseToNum = chineseToNum(f);
      const dChineseToNum = chineseToNum(d);

      return (
        f.endsWith(d) ||
        fNumToChinese.endsWith(d) ||
        f.endsWith(dNumToChinese) ||
        fChineseToNum.endsWith(d) ||
        f.endsWith(dChineseToNum) ||
        fNumToChinese.endsWith(dNumToChinese) ||
        fChineseToNum.endsWith(dChineseToNum)
      );
    }
    async function ocrAndCompare() {
      const file = document.getElementById('deedImg').files[0];
      if (!file) return alert('請先上傳照片');
      const address = document.querySelector('input[name="address"]').value.trim();
      const floorInput = document.querySelector('input[name="floor"]').value.trim();
      const area = document.querySelector('input[name="area"]').value.trim();
      if (!address || !floorInput || !area) {
        alert('請先填寫地址、總樓層、坪數再上傳謄本比對');
        return;
      }
      document.getElementById('ocrResult').innerText = '辨識中...';
      const { data: { text } } = await Tesseract.recognize(file, 'chi_tra');
      document.getElementById('ocrResult').innerText = text;

      // 取得謄本建物門牌、層數、層次、總坪數（容錯正則式）
      let deedAddress = '';
      let deedFloor = '';
      let deedLevel = '';
      let deedArea = '';
      text.split('\n').forEach(line => {
        const lineNoSpace = line.replace(/\s/g,'');
        if (!deedAddress && lineNoSpace.includes('建物門牌')) {
          deedAddress = lineNoSpace.replace(/建物門牌[:：]?/, '').trim();
        }
        if (!deedFloor && lineNoSpace.match(/層.*數/)) {
          const match = lineNoSpace.match(/層.*數[:：]?0*([0-9一二三四五六七八九十百]+)層?/);
          deedFloor = match ? match[1].replace('層','').replace(/^0+/, '').trim() : '';
          deedFloor = chineseNumberToNum(deedFloor) + '';
        }
        if (!deedLevel && lineNoSpace.match(/層.*次/)) {
          const match = lineNoSpace.match(/層.*次[:：]?([0-9一二三四五六七八九十百]+)層?/);
          deedLevel = match ? match[1].replace('層','').trim() : '';
          deedLevel = chineseNumberToNum(deedLevel) + '';
        }
        if (!deedArea && lineNoSpace.match(/總坪數/)) {
          const match = lineNoSpace.match(/總坪數[:：]?([\d.]+)/);
          deedArea = match ? match[1] : '';
        }
      });

      // 解析表單樓層
      let [inputLevel, inputFloor] = floorInput.split('/');
      inputLevel = inputLevel ? inputLevel.replace('層', '').replace(/^0+/, '').trim() : '';
      inputFloor = inputFloor ? inputFloor.replace('層', '').replace(/^0+/, '').trim() : '';
      inputLevel = chineseNumberToNum(inputLevel) + '';
      inputFloor = chineseNumberToNum(inputFloor) + '';

      // 檢查謄本資訊有無辨識到
      if (!deedAddress || !deedFloor || !deedLevel || !deedArea) {
        alert('謄本資訊無法辨識，請確認照片清晰且格式正確\n\n---\nOCR原始文字如下：\n' + document.getElementById('ocrResult').innerText);
        return;
      }

      let msg = '';
      // 地址：只要表單地址以謄本建物門牌結尾就算正確（數字/國字互容）
      if (!addressMatch(address, deedAddress)) {
        msg += `地址與謄本不符\n（表單：${address}，謄本建物門牌：${deedAddress}）\n`;
      }
      // 總樓層（層數）比對
      if (inputFloor !== deedFloor) {
        msg += `總樓層與謄本不符\n（表單：${inputFloor}，謄本層數：${deedFloor}）\n`;
      }
      // 所在樓層（層次）比對
      if (inputLevel !== deedLevel) {
        msg += `所在樓層與謄本不符\n（表單：${inputLevel}，謄本層次：${deedLevel}）\n`;
      }
      // 坪數（只比對數字，允許小數點後位數不同）
      if (area && deedArea && parseFloat(area) !== parseFloat(deedArea)) {
        msg += `坪數與謄本不符\n（表單：${area}，謄本總坪數：${deedArea}）\n`;
      }

      if (msg) alert(msg);
      else alert('謄本資訊與填寫內容一致');
    }

    // 讓產生格式的 textarea 自動變高
    function autoGrow(element) {
      element.style.height = "5px";
      element.style.height = (element.scrollHeight) + "px";
    }

    // 格局產生格式（只顯示有填寫的）
    function getLayoutValue() {
      const items = [];
      const room = document.querySelector('input[name="layout_room"]').value;
      const living = document.querySelector('input[name="layout_living"]').value;
      const bath = document.querySelector('input[name="layout_bath"]').value;
      const kitchen = document.querySelector('input[name="layout_kitchen"]').value;
      const balcony = document.querySelector('input[name="layout_balcony"]').value;
      if (room) items.push(`房${room}`);
      if (living) items.push(`廳${living}`);
      if (bath) items.push(`衛浴${bath}`);
      if (kitchen) items.push(`廚房${kitchen}`);
      if (balcony) items.push(`陽台${balcony}`);
      let options = [];
      document.querySelectorAll('input[name="layout_option"]:checked').forEach(function(cb) {
        options.push(cb.value);
      });
      if (options.length) items.push(options.join('、'));
      return items.join(' ');
    }

    // 產生格式內容
    function generate() {
      const data = new FormData(document.getElementById('houseForm'));
      let output =
        `日期：${data.get('date')} 今日物件：${data.get('today_obj') || ''}\n\n業務代租進件格式如下\n\n` +
        `可否廣告：${data.get('ad') || ''}\n\n` +
        `可否簽委托書：${data.get('sign') || ''}\n\n` +
        `地址：${data.get('address') || ''}\n\n` +
        `頂加是否為民國84年前增建：${data.get('top') || ''}\n\n` +
        `房號：${data.get('room') || ''}${data.get('room_none') ? '（無）' : ''}\n\n` +
        `總樓層：${data.get('floor') || ''}\n\n` +
        `建物型態：${data.get('type') || ''}\n\n` +
        `坪數：${data.get('area') || ''}\n\n` +
        `格局：${getLayoutValue()}\n\n` +
        `租金：${data.get('rent') || ''}\n\n` +
        `管理費：${data.get('fee') || ''}${data.get('fee_none') ? '（無）' : ''}\n\n` +
        `底價：${data.get('base') || ''}\n\n` +
        `報稅：${data.get('tax') || ''}\n\n` +
        `租補：${data.get('subsidy') || ''}\n\n` +
        `入籍：${data.get('register') || ''}\n\n` +
        `寵物：${data.get('pet') || ''}\n\n` +
        `垃圾代收：${data.get('garbage') || ''}\n\n` +
        `停車位：${data.get('parking') || ''}\n\n` +
        `公設：${data.get('public') || ''}\n\n` +
        `電費$/度：${data.get('electric') || ''}\n\n` +
        `水費：${data.get('water') || ''}\n\n` +
        `瓦斯：${data.get('gas') || ''}\n\n` +
        `鄰近交通(站點/分鐘)：${data.get('traffic') || ''}\n\n` +
        `帶看方式：${data.get('show') || ''}\n\n` +
        `附加設備：${data.get('equip') || ''}\n\n` +
        `注意事項(生活機能、東服等補充)：${data.get('note') || ''}\n\n` +
        `開發：${data.get('dev') || ''}`;
      document.getElementById('output').value = output;
      autoGrow(document.getElementById('output'));
    }

    // 複製內容到剪貼簿
    function copyText() {
      const output = document.getElementById('output');
      output.select();
      document.execCommand('copy');
      alert('已複製到剪貼簿！');
    }

    // 自動產生民國日期
    function getTaiwanDate() {
      const today = new Date();
      const year = today.getFullYear() - 1911;
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      return `${year}/${month}/${day}`;
    }
    document.getElementById('date').value = getTaiwanDate();

    // 讓所有 .auto-grow input 根據內容自動變長
    function adjustInputWidth(input) {
      let span = document.getElementById('width-tester');
      if (!span) {
        span = document.createElement('span');
        span.id = 'width-tester';
        span.style.visibility = 'hidden';
        span.style.position = 'absolute';
        span.style.whiteSpace = 'pre';
        span.style.font = window.getComputedStyle(input).font;
        document.body.appendChild(span);
      }
      span.textContent = input.value || input.placeholder || '';
      input.style.width = Math.max(120, span.offsetWidth + 20) + 'px';
    }
    document.querySelectorAll('.auto-grow').forEach(function(input) {
      input.addEventListener('input', function() {
        adjustInputWidth(this);
      });
      adjustInputWidth(input);
    });
    document.querySelectorAll('input[type="text"]').forEach(function(input) {
      input.addEventListener('input', function() {
        adjustInputWidth(this);
      });
    });
  </script>
</body>
</html>
